name: 自动化打包，部署vue项目到gh-pages分支
on: push

permissions:
  contents: write

jobs:
  npm-build:
    name: npmbuild运行
    runs-on: ubuntu-latest

    steps:
      - name: 读取仓库
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'  # 根据项目需求选择合适版本

      - name: 安装依赖
        run: npm install --verbose
        working-directory: ruoyi-ui

      - name: 打包项目
        run: npm run build:prod
        working-directory: ruoyi-ui

      - name: 检查打包输出
        run: ls -la ./dist
        working-directory: ruoyi-ui

      - name: 部署到 gh-pages 分支
        run: |
          cd ruoyi-ui
          git config --global user.name 'SEhzm'
          git config --global user.email '2693445032@qq.com'

          # 克隆 gh-pages 分支，如果不存在则创建它
          git clone -b gh-pages https://sehzm:${{ secrets.ACCESS_TOKEN }}@github.com/SEhzm/HGU-ZXXX.git ../gh-pages-repo || (git clone https://sehzm:${{ secrets.ACCESS_TOKEN }}@github.com/SEhzm/HGU-ZXXX.git ../gh-pages-repo && cd ../gh-pages-repo && git checkout --orphan gh-pages)
          
          cd ../gh-pages-repo
          
          # 删除旧的 assets 文件夹（如果存在）
          if [ -d "assets" ]; then
            rm -rf assets/
          fi
          
          # 复制 dist 目录中的文件到当前目录
          cp -r ../dist/* .  # 确保路径正确
          
          # 提交更新
          git add .
          git commit -m "自动部署: 更新打包文件，删除旧的 assets 文件夹" || echo "没有更新需要提交"
          
          # 推送 gh-pages 分支
          git push https://sehzm:${{ secrets.ACCESS_TOKEN }}@github.com/SEhzm/HGU-ZXXX.git gh-pages 
