name: 自动化打包，部署vue项目到gh-pages分支

on:
  push:

permissions:
  contents: write

jobs:
  npm-build:
    name: npmbuild运行
    runs-on: ubuntu-latest

    steps:
      - name: 读取仓库
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'  # 根据项目需求选择合适版本

      - name: 安装依赖
        run: npm install --verbose
        working-directory: ruoyi-ui

      - name: 打包项目
        run: npm run build:prod
        working-directory: ruoyi-ui

      - name: 检查打包输出
        run: |
          ls -la ./dist
          pwd
        working-directory: ruoyi-ui

      - name: 部署到 gh-pages
        run: |
          git config --global user.name "SEhzm"
          git config --global user.email "2693445032@qq.com" # 请替换为你的邮箱
          # 检查 gh-pages 分支是否存在
          if git show-ref --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            rm -rf *
          fi
          
          # 删除原有的文件
          rm -rf assets
          # 再次检查 dist 目录是否存在
          if [ ! -d "ruoyi-ui/dist" ]; then
          echo "Error: ruoyi-ui/dist directory not found."
          exit 1
          fi
          # 切换回主目录
          cd ..
          pwd
          # 使用 rsync 复制编译后的文件到当前目录
          rsync -a ruoyi-ui/dist/ .
          # 提交并推送更改
          git add .
          git commit -m "Deploy Vue project to gh-pages"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}  # GitHub Actions 自动提供的 token
