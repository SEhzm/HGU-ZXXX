name: 自动化打包，部署vue项目到zxxx库
on: push

permissions:
  contents: write

jobs:
  npm-build:
    name: npmbuild运行
    runs-on: ubuntu-latest

    steps:
      - name: 读取仓库
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'  # 根据项目需求选择合适版本

      - name: 进入 ruoyi-ui 目录
        run: cd ruoyi-ui

      - name: 安装依赖
        run: npm install --verbose
        working-directory: ruoyi-ui

      - name: 打包项目
        run: npm run build
        working-directory: ruoyi-ui

      - name: 检查打包输出
        run: ls -la ./dist  # 如果输出目录是 dist，可以用此步骤确认打包文件
        working-directory: ruoyi-ui

      - name: 部署到 HGU-ZXXX 的 gh-pages 分支
        run: |
          git config --global user.name 'SEhzm'
          git config --global user.email '2693445032@qq.com'
          git clone https://sehzm:${{ secrets.ACCESS_TOKEN }}@github.com/SEhzm/HGU-ZXXX.git hgu-zxxx
          cd hgu-zxxx
          git checkout gh-pages || git checkout --orphan gh-pages
          # 清空旧的打包文件（根据需要调整路径，避免删除不必要的文件）仅删除assets文件夹，不能删到CNAME文件
          rm -rf assets/ 
          # 创建一个临时分支用于合并
          git checkout -b temp-branch
          
          # 将打包文件复制到临时分支
          cp -r ../../ruoyi-ui/dist/* .
          git add .
          git commit -m "自动部署: 更新打包文件"
          
          # 切换回 gh-pages 分支并合并临时分支
          git checkout gh-pages
          git merge temp-branch --no-edit
          
          # 推送合并后的 gh-pages 分支
          git push https://sehzm:${{ secrets.ACCESS_TOKEN }}@github.com/SEhzm/HGU-ZXXX.git gh-pages
          
          # 删除临时分支 
          git branch -d temp-branch
